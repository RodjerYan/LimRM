// utils/addressMappings.ts

import { regionCenters } from './regionCenters';

// A dictionary to normalize different forms of region names.
// This is a crucial part for standardizing data.
const REGION_SYNONYMS: { [key: string]: string } = {
    // Republics
    'адыгея': 'Республика Адыгея',
    'алтай': 'Республика Алтай',
    'башкортостан': 'Республика Башкортостан',
    'башкирия': 'Республика Башкортостан',
    'бурятия': 'Республика Бурятия',
    'дагестан': 'Республика Дагестан',
    'ингушетия': 'Республика Ингушетия',
    'кбр': 'Кабардино-Балкарская Республика',
    'кабардино-балкария': 'Кабардино-Балкарская Республика',
    'калмыкия': 'Республика Калмыкия',
    'кчр': 'Карачаево-Черкесская Республика',
    'карачаево-черкесия': 'Карачаево-Черкесская Республика',
    'карелия': 'Республика Карелия',
    'коми': 'Республика Коми',
    'крым': 'Республика Крым',
    'марий эл': 'Республика Марий Эл',
    'мордовия': 'Республика Мордовия',
    'саха': 'Республика Саха (Якутия)',
    'якутия': 'Республика Саха (Якутия)',
    'северная осетия': 'Республика Северная Осетия — Алания',
    'алания': 'Республика Северная Осетия — Алания',
    'татарстан': 'Республика Татарстан',
    'тыва': 'Республика Тыва',
    'тува': 'Республика Тыва',
    'удмуртия': 'Удмуртская Республика',
    'хакасия': 'Республика Хакасия',
    'чр': 'Чеченская Республика',
    'чечня': 'Чеченская Республика',
    'чувашия': 'Чувашская Республика',
    // Krais
    'алтайский': 'Алтайский край',
    'забайкальский': 'Забайкальский край',
    'камчатский': 'Камчатский край',
    'краснодарский': 'Краснодарский край',
    'красноярский': 'Красноярский край',
    'пермский': 'Пермский край',
    'приморский': 'Приморский край',
    'ставропольский': 'Ставропольский край',
    'хабаровский': 'Хабаровский край',
    // Oblasts
    'амурская': 'Амурская область',
    'архангельская': 'Архангельская область',
    'астраханская': 'Астраханская область',
    'белгородская': 'Белгородская область',
    'брянская': 'Брянская область',
    'владимирская': 'Владимирская область',
    'волгоградская': 'Волгоградская область',
    'вологодская': 'Вологодская область',
    'воронежская': 'Воронежская область',
    'ивановская': 'Ивановская область',
    'иркутская': 'Иркутская область',
    'калининградская': 'Калининградская область',
    'калужская': 'Калужская область',
    'кемеровская': 'Кемеровская область — Кузбасс',
    'кузбасс': 'Кемеровская область — Кузбасс',
    'кировская': 'Кировская область',
    'костромская': 'Костромская область',
    'курганская': 'Курганская область',
    'курская': 'Курская область',
    'ленинградская': 'Ленинградская область',
    'липецкая': 'Липецкая область',
    'магаданская': 'Магаданская область',
    'московская': 'Московская область',
    'мурманская': 'Мурманская область',
    'нижегородская': 'Нижегородская область',
    'новгородская': 'Новгородская область',
    'новосибирская': 'Новосибирская область',
    'омская': 'Омская область',
    'оренбургская': 'Оренбургская область',
    'орловская': 'Орловская область',
    'пензенская': 'Пензенская область',
    'псковская': 'Псковская область',
    'ростовская': 'Ростовская область',
    'рязанская': 'Рязанская область',
    'самарская': 'Самарская область',
    'саратовская': 'Саратовская область',
    'сахалинская': 'Сахалинская область',
    'свердловская': 'Свердловская область',
    'смоленская': 'Смоленская область',
    'тамбовская': 'Тамбовская область',
    'тверская': 'Тверская область',
    'томская': 'Томская область',
    'тульская': 'Тульская область',
    'тюменская': 'Тюменская область',
    'ульяновская': 'Ульяновская область',
    'челябинская': 'Челябинская область',
    'ярославская': 'Ярославская область',
    // Federal cities
    'москва': 'Москва',
    'санкт-петербург': 'Санкт-Петербург',
    'севастополь': 'Севастополь',
    // Autonomous Oblast
    'еврейская': 'Еврейская автономная область',
    // Autonomous Okrugs
    'ненецкий': 'Ненецкий автономный округ',
    'хмао': 'Ханты-Мансийский автономный округ — Югра',
    'югра': 'Ханты-Мансийский автономный округ — Югра',
    'чукотский': 'Чукотский автономный округ',
    'янао': 'Ямало-Ненецкий автономный округ',
};

// Simplified mapping of the first 3 digits of a postal code to a region.
// This is not exhaustive but covers major regions.
const POSTAL_CODE_MAP: { [prefix: string]: string } = {
    // Moscow and Oblast
    '101': 'Москва', '102': 'Москва', '103': 'Москва', '104': 'Москва', '105': 'Москва', '106': 'Москва', '107': 'Москва', '108': 'Москва', '109': 'Москва', '111': 'Москва', '112': 'Москва', '113': 'Москва', '114': 'Москва', '115': 'Москва', '116': 'Москва', '117': 'Москва', '118': 'Москва', '119': 'Москва', '121': 'Москва', '123': 'Москва', '124': 'Москва', '125': 'Москва', '126': 'Москва', '127': 'Москва', '128': 'Москва', '129': 'Москва', '130': 'Москва', '135': 'Москва',
    '140': 'Московская область', '141': 'Московская область', '142': 'Московская область', '143': 'Московская область', '144': 'Московская область',
    // St. Petersburg and Oblast
    '187': 'Ленинградская область', '188': 'Ленинградская область',
    '190': 'Санкт-Петербург', '191': 'Санкт-Петербург', '192': 'Санкт-Петербург', '193': 'Санкт-Петербург', '194': 'Санкт-Петербург', '195': 'Санкт-Петербург', '196': 'Санкт-Петербург', '197': 'Санкт-Петербург', '198': 'Санкт-Петербург', '199': 'Санкт-Петербург',
    // Other regions
    '236': 'Калининградская область',
    '241': 'Брянская область',
    '248': 'Калужская область',
    '249': 'Калужская область',
    '300': 'Тульская область',
    '301': 'Тульская область',
    '302': 'Орловская область',
    '305': 'Курская область',
    '308': 'Белгородская область',
    '344': 'Ростовская область',
    '350': 'Краснодарский край',
    '354': 'Краснодарский край',
    '358': 'Республика Калмыкия',
    '360': 'Кабардино-Балкарская Республика',
    '364': 'Чеченская Республика',
    '367': 'Республика Дагестан',
    '385': 'Республика Адыгея',
    '390': 'Рязанская область',
    '394': 'Воронежская область',
    '400': 'Волгоградская область',
    '410': 'Саратовская область',
    '414': 'Астраханская область',
    '420': 'Республика Татарстан',
    '424': 'Республика Марий Эл',
    '426': 'Удмуртская Республика',
    '430': 'Республика Мордовия',
    '432': 'Ульяновская область',
    '440': 'Пензенская область',
    '443': 'Самарская область',
    '450': 'Республика Башкортостан',
    '454': 'Челябинская область',
    '460': 'Оренбургская область',
    '603': 'Нижегородская область',
    '610': 'Кировская область',
    '614': 'Пермский край',
    '620': 'Свердловская область',
    '625': 'Тюменская область',
    '628': 'Ханты-Мансийский автономный округ — Югра',
    '629': 'Ямало-Ненецкий автономный округ',
    '630': 'Новосибирская область',
    '644': 'Омская область',
    '650': 'Кемеровская область — Кузбасс',
    '656': 'Алтайский край',
    '660': 'Красноярский край',
    '664': 'Иркутская область',
    '670': 'Республика Бурятия',
    '672': 'Забайкальский край',
    '677': 'Республика Саха (Якутия)',
    '680': 'Хабаровский край',
    '690': 'Приморский край',
    '693': 'Сахалинская область',
};

/**
 * Normalizes a region string to a standard format.
 * Example: "орловская обл" -> "Орловская область"
 * @param regionStr The raw region string.
 * @returns The normalized region name, or the original string if no match is found.
 */
export const normalizeRegion = (regionStr: string): string => {
    if (!regionStr) return 'Регион не определён';

    const lowercased = regionStr.toLowerCase().replace(/ё/g, 'е').trim();
    
    // Direct match in synonyms
    if (REGION_SYNONYMS[lowercased]) {
        return REGION_SYNONYMS[lowercased];
    }
    
    // Handle cases like "Орловская обл."
    const words = lowercased.split(/\s+/);
    for (let i = 0; i < words.length; i++) {
        const word = words[i].replace(/[.,]/g, ''); // clean word
        if (REGION_SYNONYMS[word]) {
            return REGION_SYNONYMS[word];
        }
    }

    return regionStr.charAt(0).toUpperCase() + regionStr.slice(1);
};


/**
 * Attempts to find a region by looking for explicit keywords in the address string.
 * This is the most reliable method and has the highest priority.
 * @param address The full address string.
 * @returns The normalized region name or null if not found.
 */
export const getRegionByExplicit = (address: string): string | null => {
    const lowerAddress = address.toLowerCase().replace(/ё/g, 'е');
    
    for (const key in REGION_SYNONYMS) {
        if (lowerAddress.includes(key)) {
            // Check for whole word match to avoid partial matches like "москва" in "московская область"
            const regex = new RegExp(`\\b${key}\\b`, 'i');
            if (regex.test(lowerAddress)) {
                return REGION_SYNONYMS[key];
            }
        }
    }

    return null;
};

/**
 * Determines the region based on the first 3 digits of a postal code.
 * @param postalCode The 6-digit postal code.
 * @returns The region name or null if not found in the map.
 */
export const getRegionByPostal = (postalCode: string): string | null => {
    if (!postalCode || postalCode.length < 3) return null;
    const prefix = postalCode.substring(0, 3);
    return POSTAL_CODE_MAP[prefix] || null;
};

/**
 * Finds the region for a given city name using the `regionCenters` mapping.
 * @param city The name of the city.
 * @returns The region name or null if the city is not a known regional center.
 */
export const getRegionByCity = (city: string): string | null => {
    if (!city) return null;
    const lowerCity = city.toLowerCase().trim();
    return regionCenters[lowerCity] || null;
};
