// services/addressParser.ts
import { regionCenters, normalizeRegion } from '../utils/addressMappings';
import { ParsedAddress } from '../types';

// extendedRegionCenters — ваш + полный Крым (из сэмплов, lowercase keys, typo-fix)
const extendedRegionCenters: Record<string, string> = {
  ...regionCenters,  // Ваш базовый
  // Крым: Все города/посёлки/р-ны из сэмплов + центр
  "симферополь": "Республика Крым",
  "симферопольский": "Республика Крым",
  "керчь": "Республика Крым",
  "ф еодосия": "Республика Крым",  // Typo fix
  "феодосия": "Республика Крым",
  "ялта": "Республика Крым",
  "евпатория": "Республика Крым",
  "судак": "Республика Крым",
  "алушта": "Республика Крым",
  "бахчисарай": "Республика Крым",
  "саки": "Республика Крым",
  "гвардейское": "Республика Крым",
  "красногвардейское": "Республика Крым",
  "нижнегорский": "Республика Крым",
  "кировское": "Республика Крым",
  "ленино": "Республика Крым",
  "раздольное": "Республика Крым",
  "черноморское": "Республика Крым",
  "джанкой": "Республика Крым",
  "партенит": "Республика Крым",
  "гурзуф": "Республика Крым",
  "алупка": "Республика Крым",
  "коктебель": "Республика Крым",
  "доброе": "Республика Крым",
  "вилина": "Республика Крым",  // "Вилино"
  "зуя": "Республика Крым",
  "кам енка": "Республика Крым",  // "Каменка"
  "октябрьское": "Республика Крым",
  "новофедоровка": "Республика Крым",
  "уютное": "Республика Крым",
  "заозёрное": "Республика Крым",
  "белогорск": "Республика Крым",
  "белогорский": "Республика Крым",
  "крымская роза": "Республика Крым",  // Explicit in sample
  
  // Области: Добавки для городов/районов (примеры для топ-10; расширьте по data)
  "подольск": "Московская область",
  "химки": "Московская область",
  "одинцово": "Московская область",
  "лыткарино": "Московская область",
  "фрязино": "Московская область",
  "екатеринбург": "Свердловская область",
  "нижний тагил": "Свердловская область",
  "каменск-уральский": "Свердловская область",
  "первоуральск": "Свердловская область",
  "североуральск": "Свердловская область",
  "новосибирск": "Новосибирская область",
  "бердск": "Новосибирская область",
  "искитим": "Новосибирская область",
  "обь": "Новосибирская область",
  "колцово": "Новосибирская область",
  "воронеж": "Воронежская область",
  "липецк": "Липецкая область",
  "тамбов": "Тамбовская область",
  "ярославль": "Ярославская область",
  "рыбинск": "Ярославская область",
  "переславль- залесский": "Ярославская область",
  
  // Республики (примеры)
  "казань": "Республика Татарстан",
  "набережные челны": "Республика Татарстан",
  "альметьевск": "Республика Татарстан",
  "уфа": "Республика Башкортостан",
  "стерлитамак": "Республика Башкортостан",
  // Автономии/округа
  "биробиджан": "Еврейская автономная область",
  "нарьян-мар": "Ненецкий автономный округ",

  // Абхазия: Города из сэмпла + стандартные (lowercase keys)
  "гагра": "Республика Абхазия",
  "гал": "Республика Абхазия",
  "гудаута": "Республика Абхазия",
  "очамчира": "Республика Абхазия",
  "сухум": "Республика Абхазия",
  "питсунда": "Республика Абхазия",
  "ткуарчал": "Республика Абхазия",
  "новый афон": "Республика Абхазия",
  "гечрипш": "Республика Абхазия",
  "аауадхара": "Республика Абхазия",

  // Краснодарский край: Города/станицы/р-ны из сэмплов (lowercase keys, fix typos)
  "анапа": "Краснодарский край",
  "гостагаевская": "Краснодарский край",
  "тихо рецк": "Краснодарский край",
  "тихорецк": "Краснодарский край",
  "динская": "Краснодарский край",
  "сочи": "Краснодарский край",
  "адлерский": "Краснодарский край",
  "полтавская": "Краснодарский край",
  "владимирская": "Краснодарский край",
  "красноадр": "Краснодарский край",  // Typo for "Краснодар"
  "кропоткин": "Краснодарский край",
  "северская": "Краснодарский край",
  "темрюк": "Краснодарский край",
  "elizavetinskaya": "Краснодарский край",  // "Елизаветинская"
  "лабинск": "Краснодарский край",
  "тим ашевск": "Краснодарский край",  // "Тимашевск"
  "тимашевск": "Краснодарский край",
  "п. плодородный": "Краснодарский край",
  "гулькевичевский": "Краснодарский край",
  "новоукраинское": "Краснодарский край",
  "знаменский": "Краснодарский край",
  "выселки": "Краснодарский край",
  "ленина": "Краснодарский край",  // Common, but fallback
  "геленджик": "Краснодарский край",
  "старовиличковская": "Краснодарский край",
  "островского": "Краснодарский край",
  "мостовской": "Краснодарский край",
  "новотитаровская": "Краснодарский край",
  "морозова": "Краснодарский край",
  "анапская": "Краснодарский край",
  "варенниковская": "Краснодарский край",
  "парус": "Краснодарский край",  // "Микрорайон Парус"
  "молдавка": "Краснодарский край",
  "калининская": "Краснодарский край",
  "виноградный": "Краснодарский край",
  "лен инградская": "Краснодарский край",  // "Ленинградская"
  "усть-лабинск": "Краснодарский край",
  "васюринская": "Краснодарский край",
  "фадеева": "Краснодарский край",
  "солдатских матерей": "Краснодарский край",
  "горячий ключ": "Краснодарский край",
  "новонабережная": "Краснодарский край",
  "ильский": "Краснодарский край",
  "коммунистическая": "Краснодарский край",
  "парковая": "Краснодарский край",
  "железнодорожная": "Краснодарский край",
  "воровского": "Краснодарский край",
  "пустошкина": "Краснодарский край",
  "октябрьская": "Краснодарский край",
  "крымск": "Краснодарский край",
  "тамань": "Краснодарский край",
  "гоголя": "Краснодарский край",
  "курганинский": "Краснодарский край",
  "михайловская": "Краснодарский край",
  "индустриальная": "Краснодарский край",
  "карла маркса": "Краснодарский край",
  "50 лет октября": "Краснодарский край",
  "ейск": "Краснодарский край",
  "раевская": "Краснодарский край",
  "апшеронск": "Краснодарский край",
  "ленинградская": "Краснодарский край",
  "крутой": "Краснодарский край",
  "победы": "Краснодарский край",
  "славянск на кубани": "Краснодарский край",
  "тбилисская": "Краснодарский край",
  "гулькевичи": "Краснодарский край",
  "ярославского": "Краснодарский край",
  "ростовское шоссе": "Краснодарский край",
  "старотитаровская": "Краснодарский край",
  "цибанобалка": "Краснодарский край",
  "депутатская": "Краснодарский край",
  "космическая": "Краснодарский край",
  "адмирала пустошкина": "Краснодарский край",
  "курчанская": "Краснодарский край",
  "свердлова": "Краснодарский край",
  "авиационная": "Краснодарский край",
  "трудобеликовский": "Краснодарский край",
  "широкая щель": "Краснодарский край",
  "анастасиевская": "Краснодарский край",
  "ковтюха": "Краснодарский край",
  "рыночная площадь": "Краснодарский край",
  "запорожская": "Краснодарский край",
  "батерейная": "Краснодарский край",
  "50 лет вклксм": "Краснодарский край",
  "новомышастовская": "Краснодарский край",
  "совхозный": "Краснодарский край",
  "сенной": "Краснодарский край",
  "базарная": "Краснодарский край",
  "старокорсунская": "Краснодарский край",
  "медведовская": "Краснодарский край",
  "торговая": "Краснодарский край",
 // Ставропольский край: Города/станицы/сёла/р-ны из сэмплов (lowercase, fix typos)
 "новоалександровск": "Ставропольский край",
 "михайловск": "Ставропольский край",
 "пятигорск": "Ставропольский край",
 "лермонтов": "Ставропольский край",
 "ессентуки": "Ставропольский край",
 "буденновск": "Ставропольский край",
 "ипатово": "Ставропольский край",
 "светлоград": "Ставропольский край",
 "георгиевск": "Ставропольский край",
 "нефтекумск": "Ставропольский край",
 "кисловодск": "Ставропольский край",
 "минеральные воды": "Ставропольский край",
 "невинномысск": "Ставропольский край",
 "изобильный": "Ставропольский край",
 "благодарный": "Ставропольский край",
 "кочубеевское": "Ставропольский край",
 "донское": "Ставропольский край",
 "архангельское": "Ставропольский край",
 "иноземцево": "Ставропольский край",
 "преображенское": "Ставропольский край",
 "солдато-александровское": "Ставропольский край",
 "праковея": "Ставропольский край",
 "новоселицкое": "Ставропольский край",
 "рыздвяный": "Ставропольский край",
 "левокумское": "Ставропольский край",
 "новотроицкая": "Ставропольский край",
 "винсады": "Ставропольский край",
 "зеленокумск": "Ставропольский край",
 "железноводск": "Ставропольский край",
 "демино": "Ставропольский край",
 "мел иоратор": "Ставропольский край", // "Мелиоратор"
 "ж илноводск": "Ставропольский край", // Typo "Железноводск"
 "кочубея": "Ставропольский край",
 "барсуковская": "Ставропольский край",
 "каху н": "Кабардино-Балкарская Республика", // "Кахун"
 "урванский": "Кабардино-Балкарская Республика",
 "ног ир": "Республика Северная Осетия — Алания", // "Ногир"
 "чегем": "Кабардино-Балкарская Республика",
 "нарткала": "Кабардино-Балкарская Республика",
 "самашки": "Чеченская Республика",
 "урус-мартан": "Чеченская Республика",
 "пролетарское": "Ставропольский край",
 "бисултанова": "Чеченская Республика",
 "мухаммада али": "Чеченская Республика",
 "санько": "Ставропольский край",
 "германа угрюмова": "Чеченская Республика",
 "базоркина": "Республика Ингушетия",
 "цад аса": "Республика Дагестан", // "Цадаса"
 "магомедали магомеджанова": "Республика Дагестан",
 "колесникова": "Ставропольский край", // Person, but fallback
 "д нт": "Ставропольский край", // "ДНТ"
 "северная осетия": "Республика Северная Осетия — Алания",
 "армянская": "Республика Северная Осетия — Алания",
 "бамматюртовская": "Республика Дагестан",
 "омарова": "Республика Дагестан",
 "богратион": "Республика Дагестан",
 "бабаевский": "Республика Дагестан",
 "ш. каспийское": "Республика Дагестан",
 "казпийск": "Республика Дагестан", // Typo "Каспийск"
 "буйнакского": "Республика Дагестан",
 "хасавюрт": "Республика Дагестан",
 "кизилюрт": "Республика Дагестан",
 "дербент": "Республика Дагестан",
 "каловская": "Республика Дагестан", // "Каспийская"
 "гродный": "Чеченская Республика", // Typo "Грозный"
 "минральные воды": "Ставропольский край", // Typo
 "г ессентуки": "Ставропольский край", // Typo
 "г. ессентуки": "Ставропольский край",
 "нив инномыск": "Ставропольский край", // "Невинномысск"
 "касп ийск": "Республика Дагестан", // Typo
 "зеленчу кская": "Карачаево-Черкесская Республика", // "Зеленчукская"
 "ст. зеленчукская": "Карачаево-Черкесская Республика",
 "моздок": "Республика Северная Осетия — Алания",
 "ардон": "Республика Северная Осетия — Алания",
};

export async function parseRussianAddress(address: string): Promise<ParsedAddress> {
 if (!address || typeof address !== 'string') {
 return { region: 'Регион не определён', city: 'Неизвестный' };
 }

 // Skip "Строка #XXXXXX"
 if (address.toLowerCase().startsWith('строка #')) {
 return { region: 'Адрес не записан', city: 'Адрес не записан' };
 }

 // Step 1: Enhanced cleaning (Caucasus-specific: ст., р-н, мкр., тел.)
 let clean = address
 .toLowerCase()
 .trim()
 // Phones/markets
 .replace(/\+?7[\s\(\)\d-]{10,15}/g, '')
 .replace(/\s+(рынок|центральный рынок|оптовый склад|маг\s*№?|маг\.?|зоотовары|нарасхват|чегем|шинкуба|днт|снт|мкр\.?|тк|павильон|бутик|сектор|автовокзал|тц|гипермаркет|супермаркет)\s+/g, ' ')
 // Indexes/CSV
 .replace(/\d{6}[,\s]*/g, '').replace(/[,;]/g, ' ')
 // Caucasus fixes
 .replace(/ст-?ца\s*/g, 'ст. ') // Stanytsa
 .replace(/г\.(\s+)?([а-яё]+)/g, 'г $2') // "г. Михайловск" -> "г михайловск"
 .replace(/г ессентуки/g, 'г ессентуки') // Typo fix
 .replace(/минральные воды/g, 'минеральные воды')
 .replace(/гродный/g, 'грозный')
 .replace(/нив инномыск/g, 'невинномысск')
 .replace(/касп ийск/g, 'каспийск')
 .replace(/\s+/g, ' ')
 // Shorts after
 .replace(/обл\.?/g, ' область').replace(/край\.?/g, ' край').replace(/респ\.?/g, ' республика')
 .replace(/авт\.?округ\.?/g, ' автономный округ').replace(/р-н\b/g, ' район')
 .replace(/г\.?\s*/g, 'г ').replace(/пос\.?\s*/g, 'пос ').replace(/п\.?\s*/g, 'п ').replace(/с\.?\s*/g, 'с ')
 .replace(/\s+/g, ' ');

 // Step 2: Explicit
 const explicitPattern = /([а-яё\s-]+?(?:область|край|республика|автономная область|автономный округ|город федерального значения|кбр|рсо-ала ния|чр))/i;
 let region = 'Регион не определён';
 const explicitMatch = clean.match(explicitPattern);
 if (explicitMatch) {
 let rawRegion = explicitMatch[1].trim();
 region = normalizeRegion(rawRegion); // Ваш util
 }

 // Step 3: City (added с. for selo, ст. for stanytsa)
 const cityPatterns = [/г\s+([а-яё\s\-]+)/i, /ст\.?\s+([а-яё\s\-]+)/i, /пос\s+([а-яё\s\-]+)/i, /п\s+([а-яё\s\-]+)/i, /с\s+([а-яё\s\-]+)/i];
 let city = region;
 for (const pattern of cityPatterns) {
 const match = clean.match(pattern);
 if (match && match[1]) {
 let cityStr = match[1].trim();
 // Cut at ул/д./р-н/ст./мкр./тел.
 const cutIndex = cityStr.search(/\s+(ул|д\.|р-?н|ст\.?|мкр\.?|пер|б-р|пр-?кт|дом|кв|пав|литер|тел|\+?7)/i);
 if (cutIndex > 0) cityStr = cityStr.substring(0, cutIndex);
 city = cityStr.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
 break;
 }
 }

 // Step 4: Fallback
 if (region === 'Регион не определён') {
 const words = clean.split(' ');
 for (const word of words) {
 let cityKey = word.replace(/[^а-яё-]/g, '').replace(/\s+/g, '-');
 if (extendedRegionCenters[cityKey]) {
 region = extendedRegionCenters[cityKey];
 if (city === region) {
 city = cityKey.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
 }
 break;
 }
 }
 }

 return { region, city };
}