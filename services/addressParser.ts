// services/addressParser.ts
import { regionCenters, normalizeRegion } from '../utils/addressMappings';
import { ParsedAddress } from '../types';

/* -------------------------------------------------------------
   1. Объединённый словарь: базовые центры + расширенные fallback
   ------------------------------------------------------------- */
const extendedRegionCenters: Record<string, string> = {
    ...regionCenters,

    // -- Калининградская область --
    "калининград": "Калининградская область",
    "гурьевск": "Калининградская область",
    "советск": "Калининградская область",
    "пионерский": "Калининградская область",
    "светлогорск": "Калининградская область",
    "светлый": "Калининградская область",
    "багратионовск": "Калининградская область",
    "большоеисаково": "Калининградская область",
    "голубево": "Калининградская область",
    "зеленоградск": "Калининградская область",
    "черняховск": "Калининградская область",
    "гвардейск": "Калининградская область",
    "балтийск": "Калининградская область",
    "матросово": "Калининградская область",
    "неман": "Калининградская область",
    "мамоново": "Калининградская область",
    
    // -- Санкт-Петербург + Ленинградская область --
    "спб": "Санкт-Петербург",
    "санктпетербург": "Санкт-Петербург",
    "санкт‑петербург": "Санкт-Петербург",
    "петербург": "Санкт-Петербург",
    "колпино": "Санкт-Петербург",
    "красное село": "Санкт-Петербург",
    "парголово": "Санкт-Петербург",
    "мурино": "Ленинградская область",
    "кудрово": "Ленинградская область",
    "пушкин": "Санкт-Петербург",
    "павловск": "Санкт-Петербург",
    "сланцы": "Ленинградская область",
    "ломоносов": "Ленинградская область",
    "сиверский": "Ленинградская область",
    "гатчина": "Ленинградская область",
    "всеволожск": "Ленинградская область",
    "волхов": "Ленинградская область",
    "кипень": "Ленинградская область",
    "ло": "Ленинградская область",
    "кириши": "Ленинградская область",
    "ивангород": "Ленинградская область",
    "лодейное-поле": "Ленинградская область",
    "луга": "Ленинградская область",
    "приозерск": "Ленинградская область",
    "великийновгород": "Новгородская область",
    "теучеж": "Республика Адыгея",
    "энем": "Республика Адыгея",
    "трехстропье": "Республика Адыгея",
    "гиагинская": "Республика Адыгея",
    "коджеско": "Республика Адыгея",
    "тхабсим": "Республика Адыгея",
    "пшихач": "Республика Адыгея",
    "кужорская": "Республика Адыгея",
    "майма": "Республика Алтай",
    "чомыш": "Республика Алтай",
    "солонешное": "Республика Алтай",
    "кызыл-мазал": "Республика Алтай",
    "катуар": "Республика Алтай",
    "иогач": "Республика Алтай",
    "кокса": "Республика Алтай",
    "туекта": "Республика Алтай",
    "стерлитамак": "Республика Башкортостан",
    "салават": "Республика Башкортостан",
    "нефтекамск": "Республика Башкортостан",
    "белорецк": "Республика Башкортостан",
    "сибай": "Республика Башкортостан",
    "туймазы": "Республика Башкортостан",
    "кумертау": "Республика Башкортостан",
    "мега": "Республика Башкортостан",
    "северобайкальск": "Республика Бурятия",
    "гусиноозерск": "Республика Бурятия",
    "severobaikalsk": "Республика Бурятия",
    "кижингу": "Республика Бурятия",
    "забайкальск": "Республика Бурятия",
    "борзя": "Республика Бурятия",
    "мухоршибирь": "Республика Бурятия",
    "таксимо": "Республика Бурятия",
    "каспийск": "Республика Дагестан",
    "хасавюрт": "Республика Дагестан",
    "южно-сулакский": "Республика Дагестан",
    "южно-сулак": "Республика Дагестан",
    "дагестанские огни": "Республика Дагестан",
    "избербаш": "Республика Дагестан",
    "хасавюртовский": "Республика Дагестан",
    "кизиляюрт": "Республика Дагестан",
    "цад аса": "Республика Дагестан",
    "магомедали магомеджанова": "Республика Дагестан",
    "бамматюртовская": "Республика Дагестан",
    "омарова": "Республика Дагестан",
    "богратион": "Республика Дагестан",
    "бабаевский": "Республика Дагестан",
    "ш. каспийское": "Республика Дагестан",
    "казпийск": "Республика Дагестан",
    "буйнакского": "Республика Дагестан",
    "каловская": "Республика Дагестан",
    "касп ийск": "Республика Дагестан",
    "назрань": "Республика Ингушетия",
    "малгобек": "Республика Ингушетия",
    "малгобекский": "Республика Ингушетия",
    "назрановский": "Республика Ингушетия",
    "сунженский": "Республика Ингушетия",
    "джейрахский": "Республика Ингушетия",
    "базоркина": "Республика Ингушетия",
    "прохладный": "Кабардино-Балкарская Республика",
    "майский": "Кабардино-Балкарская Республика",
    "тырныауз": "Кабардино-Балкарская Республика",
    "баксан": "Кабардино-Балкарская Республика",
    "малка": "Кабардино-Балкарская Республика",
    "терск": "Кабардино-Балкарская Республика",
    "урванский": "Кабардино-Балкарская Республика",
    "захальдинский": "Кабардино-Балкарская Республика",
    "чегемский": "Кабардино-Балкарская Республика",
    "каху н": "Кабардино-Балкарская Республика",
    "чегем": "Кабардино-Балкарская Республика",
    "нарткала": "Кабардино-Балкарская Республика",
    "городовиковск": "Республика Калмыкия",
    "ларино": "Республика Калмыкия",
    "яган": "Республика Калмыкия",
    "уста-хуру": "Республика Калмыкия",
    "ики-бурул": "Республика Калмыкия",
    "чернь": "Республика Калмыкия",
    "пантелеймон": "Республика Калмыкия",
    "приютное": "Республика Калмыкия",
    "ягорлык": "Республика Калмыкия",
    "усть-джегута": "Карачаево-Черкесская Республика",
    "к Aram": "Карачаево-Черкесская Республика",
    "микоян": "Карачаево-Черкесская Республика",
    "зеленчукская": "Карачаево-Черкесская Республика",
    "хумара": "Карачаево-Черкесская Республика",
    "инж": "Карачаево-Черкесская Республика",
    "родники": "Карачаево-Черкесская Республика",
    "зеленчу кская": "Карачаево-Черкесская Республика",
    "ст. зеленчукская": "Карачаево-Черкесская Республика",
    "кемь": "Республика Карелия",
    "кондопога": "Республика Карелия",
    "сегежа": "Республика Карелия",
    "суоярви": "Республика Карелия",
    "сорск": "Республика Карелия",
    "питкяранта": "Республика Карелия",
    "олонец": "Республика Карелия",
    "лада": "Республика Карелия",
    "пудож": "Республика Карелия",
    "инта": "Республика Коми",
    "воркута": "Республика Коми",
    "усинск": "Республика Коми",
    "пекра": "Республика Коми",
    "микунь": "Республика Коми",
    "сосногорск": "Республика Коми",
    "укта": "Республика Коми",
    "емва": "Республика Коми",
    "кослан": "Республика Коми",
    "ф еодосия": "Республика Крым",
    "феодосия": "Республика Крым",
    "ялта": "Республика Крым",
    "евпатория": "Республика Крым",
    "судак": "Республика Крым",
    "алушта": "Республика Крым",
    "бахчисарай": "Республика Крым",
    "симферопольский": "Республика Крым",
    "саки": "Республика Крым",
    "гвардейское": "Республика Крым",
    "красногвардейское": "Республика Адыгея",
    "нижнегорский": "Республика Крым",
    "ленино": "Краснодарский край",
    "раздольное": "Республика Крым",
    "черноморское": "Республика Крым",
    "джанкой": "Республика Крым",
    "партенит": "Республика Крым",
    "гурзуф": "Республика Крым",
    "алупка": "Республика Крым",
    "коктебель": "Республика Крым",
    "вилина": "Республика Крым",
    "зуя": "Республика Крым",
    "кам енка": "Республика Крым",
    "новофедоровка": "Республика Крым",
    "уютное": "Республика Крым",
    "заозёрное": "Республика Крым",
    "белогорский": "Республика Крым",
    "крымская роза": "Республика Крым",
    "волжск": "Республика Марий Эл",
    "зеленый город": "Республика Марий Эл",
    "медведево": "Республика Марий Эл",
    "морки": "Республика Марий Эл",
    "куженер": "Республика Марий Эл",
    "пайгарма": "Республика Марий Эл",
    "кизнер": "Республика Марий Эл",
    "советский": "Республика Марий Эл",
    "марий эл": "Республика Марий Эл",
    "рузаевка": "Республика Мордовия",
    "ковылкино": "Республика Мордовия",
    "инсар": "Республика Мордовия",
    "арадат": "Республика Мордовия",
    "хамаска": "Республика Мордовия",
    "ромоданово": "Республика Мордовия",
    "чами": "Республика Мордовия",
    "мордовия": "Республика Мордовия",
    "нерегу": "Республика Саха (Якутия)",
    "мирный": "Республика Саха (Якутия)",
    "покровск": "Республика Саха (Якутия)",
    "алданы": "Республика Саха (Якутия)",
    "нерюнгри": "Республика Саха (Якутия)",
    "хани": "Республика Саха (Якутия)",
    "дебины": "Республика Саха (Якутия)",
    "сунтар": "Республика Саха (Якутия)",
    "верхоянск": "Республика Саха (Якутия)",
    "моздок": "Республика Северная Осетия — Алания",
    "дигора": "Республика Северная Осетия — Алания",
    "ардон": "Республика Северная Осетия — Алания",
    "беса": "Республика Северная Осетия — Алания",
    "алджир": "Республика Северная Осетия — Алания",
    "гизель": "Республика Северная Осетия — Алания",
    "пригородный": "Республика Северная Осетия — Алания",
    "кимо": "Республика Северная Осетия — Алания",
    "ног ир": "Республика Северная Осетия — Алания",
    "северная осетия": "Республика Северная Осетия — Алания",
    "армянская": "Республика Северная Осетия — Алания",
    "назеля": "Республика Татарстан",
    "альметьевск": "Республика Татарстан",
    "набережные-челны": "Республика Татарстан",
    "нижнекамск": "Республика Татарстан",
    "еленовка": "Республика Татарстан",
    "заинск": "Республика Татарстан",
    "чистополь": "Республика Татарстан",
    "нурлат": "Республика Татарстан",
    "арск": "Республика Татарстан",
    "ак-довурок": "Республика Тыва",
    "тоожу": "Республика Тыва",
    "сарыг-сеп": "Республика Тыва",
    "кай": "Республика Тыва",
    "тээли": "Республика Тыва",
    "чадаан": "Республика Тыва",
    "чурга": "Республика Тыва",
    "самагалтай": "Республика Тыва",
    "тоя": "Республика Тыва",
    "сарапул": "Удмуртская Республика",
    "мокси": "Удмуртская Республика",
    "гольяны": "Удмуртская Республика",
    "кез": "Удмуртская Республика",
    "григорьевка": "Удмуртская Республика",
    "ишим": "Удмуртская Республика",
    "дебёсы": "Удмуртская Республика",
    "каракулино": "Удмуртская Республика",
    "кильмезь": "Удмуртская Республика",
    "черногорск": "Республика Хакасия",
    "саяногорск": "Республика Хакасия",
    "абаза": "Республика Хакасия",
    "таштагол": "Республика Хакасия",
    "уст-абакан": "Республика Хакасия",
    "бея": "Республика Хакасия",
    "альберт": "Республика Хакасия",
    "гудаур": "Чеченская Республика",
    "ургуб": "Чеченская Республика",
    "шали": "Чеченская Республика",
    "ургус-стан": "Чеченская Республика",
    "аргун": "Чеченская Республика",
    "гудермес": "Чеченская Республика",
    "кезенойам": "Чеченская Республика",
    "центорой": "Чеченская Республика",
    "самашки": "Чеченская Республика",
    "бисултанова": "Чеченская Республика",
    "мухаммада али": "Чеченская Республика",
    "германа угрюмова": "Чеченская Республика",
    "гродный": "Чеченская Республика",
    "новочебоксарск": "Чувашская Республика",
    "цивиля": "Чувашская Республика",
    "алатырь": "Чувашская Республика",
    "юман": "Чувашская Республика",
    "канадей": "Чувашская Республика",
    "клетия": "Чувашская Республика",
    "цивильск": "Чувашская Республика",
    "бийск": "Алтайский край",
    "рубцовск": "Алтайский край",
    "новоалтайск": "Алтайский край",
    "змеиногорск": "Алтайский край",
    "алтайское": "Алтайский край",
    "благовещенка": "Алтайский край",
    "александровка": "Алтайский край",
    "косиха": "Алтайский край",
    "чите": "Забайкальский край",
    "краснокаменск": "Забайкальский край",
    "балей": "Забайкальский край",
    "петровск- Забайкальский": "Забайкальский край",
    "могоча": "Забайкальский край",
    "чернышевск": "Забайкальский край",
    "карымское": "Забайкальский край",
    "кыра": "Красноярский край",
    "вилючинск": "Камчатский край",
    "елизово": "Камчатский край",
    "паратунка": "Камчатский край",
    "мильково": "Камчатский край",
    "палана": "Камчатский край",
    "усть-камчатск": "Камчатский край",
    "тигиль": "Камчатский край",
    "коряки": "Камчатский край",
    "быстринский": "Камчатский край",
    "новороссийск": "Краснодарский край",
    "туапсе": "Краснодарский край",
    "славянск-на-кубани": "Краснодарский край",
    "гостагаевская": "Краснодарский край",
    "тихо рецк": "Краснодарский край",
    "тихорецк": "Краснодарский край",
    "динская": "Краснодарский край",
    "адлерский": "Краснодарский край",
    "полтавская": "Краснодарский край",
    "владимирская": "Краснодарский край",
    "красноадр": "Краснодарский край",
    "северская": "Краснодарский край",
    "темрюк": "Краснодарский край",
    "elizavetinskaya": "Краснодарский край",
    "лабинск": "Краснодарский край",
    "тим ашевск": "Краснодарский край",
    "тимашевск": "Краснодарский край",
    "п. плодородный": "Краснодарский край",
    "гулькевичевский": "Краснодарский край",
    "новоукраинское": "Краснодарский край",
    "знаменский": "Краснодарский край",
    "выселки": "Краснодарский край",
    "старовиличковская": "Краснодарский край",
    "островского": "Краснодарский край",
    "мостовской": "Краснодарский край",
    "новотитаровская": "Краснодарский край",
    "морозова": "Краснодарский край",
    "анапская": "Краснодарский край",
    "варенниковская": "Краснодарский край",
    "парус": "Краснодарский край",
    "молдавка": "Краснодарский край",
    "калининская": "Краснодарский край",
    "виноградный": "Краснодарский край",
    "лен инградская": "Краснодарский край",
    "усть-лабинск": "Краснодарский край",
    "васюринская": "Краснодарский край",
    "фадеева": "Краснодарский край",
    "солдатских матерей": "Краснодарский край",
    "горячий ключ": "Краснодарский край",
    "новонабережная": "Краснодарский край",
    "ильский": "Краснодарский край",
    "коммунистическая": "Краснодарский край",
    "парковая": "Краснодарский край",
    "железнодорожная": "Краснодарский край",
    "воровского": "Краснодарский край",
    "пустошкина": "Краснодарский край",
    "крымск": "Краснодарский край",
    "тамань": "Краснодарский край",
    "гоголя": "Краснодарский край",
    "курганинский": "Краснодарский край",
    "михайловская": "Краснодарский край",
    "индустриальная": "Краснодарский край",
    "50 лет октября": "Краснодарский край",
    "ейск": "Краснодарский край",
    "раевская": "Краснодарский край",
    "апшеронск": "Краснодарский край",
    "ленинградская": "Краснодарский край",
    "крутой": "Краснодарский край",
    "победы": "Краснодарский край",
    "славянск на кубани": "Краснодарский край",
    "тбилисская": "Краснодарский край",
    "гулькевичи": "Краснодарский край",
    "ярославского": "Краснодарский край",
    "ростовское шоссе": "Краснодарский край",
    "старотитаровская": "Краснодарский край",
    "цибанобалка": "Краснодарский край",
    "депутатская": "Краснодарский край",
    "космическая": "Краснодарский край",
    "адмирала пустошкина": "Краснодарский край",
    "курчанская": "Краснодарский край",
    "свердлова": "Краснодарский край",
    "авиационная": "Краснодарский край",
    "трудобеликовский": "Краснодарский край",
    "широкая щель": "Краснодарский край",
    "анастасиевская": "Краснодарский край",
    "ковтюха": "Краснодарский край",
    "рыночная площадь": "Краснодарский край",
    "запорожская": "Запорожская область",
    "батерейная": "Краснодарский край",
    "50 лет вклксм": "Краснодарский край",
    "новомышастовская": "Краснодарский край",
    "совхозный": "Краснодарский край",
    "сенной": "Краснодарский край",
    "базарная": "Краснодарский край",
    "старокорсунская": "Краснодарский край",
    "медведовская": "Краснодарский край",
    "торговая": "Краснодарский край",
    "ачинск": "Красноярский край",
    "кандалакша": "Красноярский край",
    "лесосибирск": "Красноярский край",
    "сосновоборск": "Республика Хакасия",
    "забаикальск": "Красноярский край",
    "березники": "Пермский край",
    "соликамск": "Пермский край",
    "лысьва": "Пермский край",
    "кизел": "Пермский край",
    "чусовой": "Пермский край",
    "кос": "Пермский край",
    "добрянка": "Пермский край",
    "губаха": "Пермский край",
    "у ss ур ийск": "Приморский край",
    "нах одка": "Приморский край",
    "артем": "Приморский край",
    "лау тов": "Приморский край",
    "спасск-дальний": "Приморский край",
    "дальнереченск": "Приморский край",
    "покровское": "Приморский край",
    "лучегорск": "Приморский край",
    "минеральные-воды": "Ставропольский край",
    "кисловодск": "Ставропольский край",
    "невинномысск": "Ставропольский край",
    "буденновск": "Ставропольский край",
    "г еоргиевск": "Ставропольский край",
    "изобильный": "Ставропольский край",
    "светлоград": "Ставропольский край",
    "новоалександровск": "Ставропольский край",
    "михайловск": "Ставропольский край",
    "лермонтов": "Ставропольский край",
    "нефтекумск": "Ставропольский край",
    "благодарный": "Ставропольский край",
    "кочубеевское": "Ставропольский край",
    "донское": "Ставропольский край",
    "архангельское": "Ставропольский край",
    "иноземцево": "Ставропольский край",
    "преображенское": "Ставропольский край",
    "солдато-александровское": "Ставропольский край",
    "праковея": "Ставропольский край",
    "новоселицкое": "Ставропольский край",
    "рыздвяный": "Ставропольский край",
    "левокумское": "Ставропольский край",
    "новотроицкая": "Ставропольский край",
    "винсады": "Ставропольский край",
    "зеленокумск": "Ставропольский край",
    "железноводск": "Ставропольский край",
    "демино": "Ставропольский край",
    "мел иоратор": "Ставропольский край",
    "ж илноводск": "Ставропольский край",
    "кочубея": "Ставропольский край",
    "барсуковская": "Ставропольский край",
    "пролетарское": "Ставропольский край",
    "санько": "Ставропольский край",
    "колесникова": "Ставропольский край",
    "д нт": "Ставропольский край",
    "минральные воды": "Ставропольский край",
    "г ессентуки": "Ставропольский край",
    "г. ессентуки": "Ставропольский край",
    "нив инномыск": "Ставропольский край",
    "комсомольск-на-амуре": "Хабаровский край",
    "юности": "Хабаровский край",
    "хабаровский": "Хабаровский край",
    "амурск": "Хабаровский край",
    "николаевск-на-амуре": "Хабаровский край",
    "ванино": "Хабаровский край",
    "советская-Гавань": "Хабаровский край",
    "хурмули": "Хабаровский край",
    "свободный": "Амурская область",
    "белогорск": "Республика Крым",
    "райчихинск": "Амурская область",
    "прогресс": "Амурская область",
    "зея": "Амурская область",
    "тында": "Амурская область",
    "уркана": "Амурская область",
    "серышево": "Амурская область",
    "сковородино": "Амурская область",
    "северодвинск": "Архангельская область",
    "котлас": "Архангельская область",
    "коряжма": "Архангельская область",
    "новодвинск": "Архангельская область",
    "карпогоры": "Архангельская область",
    "моржовец": "Архангельская область",
    "пинег": "Архангельская область",
    "мезень": "Архангельская область",
    "знаменск": "Астраханская область",
    "ахтубинск": "Астраханская область",
    "харабалин": "Астраханская область",
    "нариманов": "Астраханская область",
    "ипатово": "Ставропольский край",
    "володарский": "Астраханская область",
    "карамышка": "Астраханская область",
    "чернышков": "Астраханская область",
    "хаджи-мurat": "Астраханская область",
    "старый-ос кол": "Белгородская область",
    "губкин": "Белгородская область",
    "шевенг": "Белгородская область",
    "старово": "Белгородская область",
    "алексеевка": "Самарская область",
    "валуйки": "Белгородская область",
    "степан": "Белгородская область",
    "разумное": "Белгородская область",
    "томаровка": "Белгородская область",
    "клинцы": "Брянская область",
    "новозыбков": "Брянская область",
    "унеча": "Брянская область",
    "кардым": "Брянская область",
    "фокино": "Брянская область",
    "сельцо": "Брянская область",
    "дыбово": "Брянская область",
    "мглин": "Брянская область",
    "ковров": "Владимирская область",
    "музров": "Владимирская область",
    "александров": "Владимирская область",
    "колу тов": "Владимирская область",
    "суздаль": "Владимирская область",
    "гусь-хрустальный": "Владимирская область",
    "покров": "Владимирская область",
    "собинка": "Владимирская область",
    "вязники": "Владимирская область",
    "михайловка": "Волгоградская область",
    "урюпино": "Волгоградская область",
    "фролово": "Волгоградская область",
    "светлый-яр": "Волгоградская область",
    "котов": "Волгоградская область",
    "николаевск": "Волгоградская область",
    "иловля": "Волгоградская область",
    "сокол": "Вологодская область",
    "тотьма": "Вологодская область",
    "великий-устюг": "Вологодская область",
    "кадый": "Вологодская область",
    "грахово": "Вологодская область",
    "харовск": "Вологодская область",
    "вытегра": "Вологодская область",
    "борисоглебск": "Воронежская область",
    "ус ман": "Воронежская область",
    "кашира": "Московская область",
    "зарайск": "Московская область",
    "ступино": "Московская область",
    "луховицы": "Московская область",
    "раменское": "Московская область",
    "серебряные пруды": "Московская область",
    "балашиха": "Московская область",
    "реутов": "Московская область",
    "истра": "Московская область",
    "можайск": "Московская область",
    "волоколамск": "Московская область",
    "лотошино": "Московская область",
    "талдом": "Московская область",
    "сергиев посад": "Московская область",
    "ивантеевка": "Московская область",
    "черноголовка": "Московская область",
    "павловский посад": "Московская область",
    "орехово-зуево": "Московская область",
    "шатура": "Московская область",
    "егорьевск": "Московская область",
    "коломна": "Московская область",
    "дзержинский": "Московская область",
    "бронницы": "Московская область",
    "электрогорск": "Московская область",
    "рошаль": "Московская область",
    "протвино": "Московская область",
    "пущино": "Московская область",
    "климовск": "Московская область",
    "троицк": "Москва",
    "зеленоград": "Москва",
    "щербинка": "Москва",
    "наро-фоминск": "Московская область",
    "кубинка": "Московская область",
    "звенигород": "Московская область",
    "дедовск": "Московская область",
    "высоковск": "Московская область",
    "яхрома": "Московская область",
    "пересвет": "Московская область",
    "краснозаводск": "Московская область",
    "хотьково": "Московская область",
    "старая купавна": "Московская область",
    "электроугли": "Московская область",
    "ликино-дулёво": "Московская область",
    "куровское": "Московская область",
    "дрезна": "Московская область",
    "ожерелье": "Московская область",
    "верея": "Московская область",
    "апрелевка": "Московская область",
    "голицыно": "Московская область",
    "краснознаменск": "Московская область",
    "власиха": "Московская область",
    "восход": "Московская область",
    "молодёжный": "Московская область",
    "звёздный городок": "Московская область",
    "лосино-петровский": "Московская область",
    "домодедово": "Московская область",
    "подольск": "Московская область",
    "люберцы": "Московская область",
    "видное": "Московская область",
    "чехов": "Московская область",
    "серпухов": "Московская область",
    "мытищи": "Московская область",
    "королёв": "Московская область",
    "электросталь": "Московская область",
    "ногинск": "Московская область",
    "щёлково": "Московская область",
    "жуковский": "Московская область",
    "клин": "Московская область",
    "солнечногорск": "Московская область",
    "дмитров": "Московская область",
    "пушкино": "Московская область",
    "долгопрудный": "Московская область",
    "лобня": "Московская область",
    "дубна": "Московская область",
    "фрязино": "Московская область",
    "котельники": "Московская область",
    "красногорск": "Московская область",
    "одинцово": "Московская область",
    "шаховская": "Московская область",
    "донецк": "Донецкая Народная Республика",
    "макеевка": "Донецкая Народная Республика",
    "мариуполь": "Донецкая Народная Республика",
    "горловка": "Донецкая Народная Республика",
    "енакеево": "Донецкая Народная Республика",
    "харцызск": "Донецкая Народная Республика",
    "шахтёрск": "Донецкая Народная Республика",
    "снежное": "Донецкая Народная Республика",
    "зугрес": "Донецкая Народная Республика",
    "докучаевск": "Донецкая Народная Республика",
    "волноваха": "Донецкая Народная Республика",
    "ясиноватая": "Донецкая Народная Республика",
    "тельманово": "Донецкая Народная Республика",
    "амвросиевка": "Донецкая Народная Республика",
    "новоазовск": "Донецкая Народная Республика",
    "старобешево": "Донецкая Народная Республика",
    "луганск": "Луганская Народная Республика",
    "алчевск": "Луганская Народная Республика",
    "красный луч": "Луганская Народная Республика",
    "антрацит": "Луганская Народная Республика",
    "свердловск": "Луганская Народная Республика",
    "первомайск": "Луганская Народная Республика",
    "стаханов": "Луганская Народная Республика",
    "брянка": "Луганская Народная Республика",
    "кировск": "Луганская Народная Республика",
    "перевальск": "Луганская Народная Республика",
    "славяносербск": "Луганская Народная Республика",
    "рубежное": "Луганская Народная Республика",
    "лисичанск": "Луганская Народная Республика",
    "северодонецк": "Луганская Народная Республика",
    "мелитополь": "Запорожская область",
    "бердянск": "Запорожская область",
    "энергодар": "Запорожская область",
    "токмак": "Запорожская область",
    "геническ": "Херсонская область",
    "каховка": "Херсонская область",
    "скадовск": "Херсонская область",
};

/* -------------------------------------------------------------
   2. Сокращения и нормализация
   ------------------------------------------------------------- */
const ABBREVIATIONS: Record<string, string> = {
  'обл': 'область',
  'край': 'край',
  'респ': 'республика',
  'ао': 'автономный округ',
  'г': 'город',
  'п': 'посёлок',
  'пгт': 'посёлок городского типа',
  'рп': 'рабочий посёлок',
  'с': 'село',
  'д': 'деревня',
  'ст': 'станица',
  'х': 'хутор',
  'мкр': 'микрорайон',
  'тер': 'территория',
  'кп': 'коттеджный посёлок',
  'снт': 'садовое некоммерческое товарищество',
  'днт': 'дачное некоммерческое товарищество',
};

const replaceAbbr = (str: string): string => {
  // Fix: Correctly handle abbreviations with or without dots, followed by a space or end of string.
  let result = str.replace(/\b([а-яё]+)\.(\s|$)/gi, (match, word, spaceOrEnd) => {
    const clean = word.toLowerCase();
    return ABBREVIATIONS[clean] ? ABBREVIATIONS[clean] + spaceOrEnd : match;
  });

  result = result.replace(/\b(обл|край|респ|ао|г|п|пгт|рп|с|д|ст|х|мкр|тер|кп|снт|днт)\b/gi, (match) => {
     const clean = match.toLowerCase();
     return ABBREVIATIONS[clean] || match;
  });

  return result;
};


/* -------------------------------------------------------------
   3. Предвычисленные структуры
   ------------------------------------------------------------- */
// FIX: Use the defined 'extendedRegionCenters' instead of the undefined 'mergedCityToRegion'. This resolves the 'Cannot find name' error and subsequent type errors.
const ALL_REGIONS = [...new Set(Object.values(extendedRegionCenters))]
  .map(r => ({ normalized: r.toLowerCase(), original: normalizeRegion(r) }))
  .sort((a, b) => b.normalized.length - a.normalized.length);

// FIX: Use the defined 'extendedRegionCenters' instead of the undefined 'mergedCityToRegion'.
const SORTED_CITY_KEYS = Object.keys(extendedRegionCenters)
  .map(k => k.toLowerCase())
  .sort((a, b) => b.length - a.length);

const REGION_TO_CENTER: Record<string, string> = {};
for (const [city, region] of Object.entries(regionCenters)) {
  REGION_TO_CENTER[normalizeRegion(region)] = city.charAt(0).toUpperCase() + city.slice(1);
}

// --- Специально для Московской области ---
const MOSCOW_OBLAST_VARIANTS = [
  'московская область',
  'московская обл',
  'мо',
  'мособл',
  'мос обл',
  'моск обл',
].map(v => v.toLowerCase());

const MOSCOW_CITY_VARIANTS = [
  'москва', 'москвы', 'мск', 'моск'
].map(v => v.toLowerCase());

const DNR_VARIANTS = ['донецкая народная республика','донецкая народная респ','днр','донецкая нр','донецкая республика'].map(v=>v.toLowerCase());
const LNR_VARIANTS = ['луганская народная республика','луганская народная респ','лнр'].map(v=>v.toLowerCase());
const ZAPOR_VARIANTS = ['запорожская область','запорожская обл','запорожье'].map(v=>v.toLowerCase());
const KHERSON_VARIANTS = ['херсонская область','херсонская обл','херсон'].map(v=>v.toLowerCase());


/* -------------------------------------------------------------
   4. Основная функция
   ------------------------------------------------------------- */
export function parseRussianAddress(address: string): ParsedAddress {
    if (!address?.trim() || /^строка\s*#\d+/i.test(address)) {
        return { region: 'Адрес не записан', city: 'Адрес не записан' };
    }

    const original = address;
    let lower = address.toLowerCase();

    // A more comprehensive cleaning process
    let clean = lower
        .replace(/ё/g, 'е')
        .replace(/\+?7[\s\(\)\d-]{10,15}/g, '') // phones
        .replace(/\d{6}/g, '') // postal codes
        .replace(/[,;]/g, ' ')
        .replace(/\s+(рынок|маг|тц|тк|ип|ооо|зао|снт|днт)\b/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();

    // Replace abbreviations AFTER basic cleaning
    clean = replaceAbbr(clean);

    let region: string | null = null;
    let city: string | null = null;

    // === 1. Московская область — приоритет! ===
    if (MOSCOW_OBLAST_VARIANTS.some(v => lower.includes(v))) {
        region = 'Московская область';
    }

    // === 2. Москва — отдельно ===
    if (!region && MOSCOW_CITY_VARIANTS.some(v => lower.includes(v))) {
        return { region: 'Москва', city: 'Москва' };
    }

    if (!region) {
        if (DNR_VARIANTS.some(v => lower.includes(v))) {
          region = 'Донецкая Народная Республика';
        } else if (LNR_VARIANTS.some(v => lower.includes(v))) {
          region = 'Луганская Народная Республика';
        } else if (ZAPOR_VARIANTS.some(v => lower.includes(v))) {
          region = 'Запорожская область';
        } else if (KHERSON_VARIANTS.some(v => lower.includes(v))) {
          region = 'Херсонская область';
        }
      }

    // === 3. Явное имя региона ===
    if (!region) {
        for (const r of ALL_REGIONS) {
            if (clean.includes(r.normalized)) {
                region = r.original;
                break;
            }
        }
    }

    // === 4. Город из словаря (самые длинные ключи сначала) ===
    for (const key of SORTED_CITY_KEYS) {
        if (clean.includes(key)) {
            // FIX: Use the defined 'extendedRegionCenters' instead of the undefined 'mergedCityToRegion'.
            const originalKey = Object.keys(extendedRegionCenters).find(
                k => k.toLowerCase() === key
            )!;
            city = originalKey.charAt(0).toUpperCase() + originalKey.slice(1);
            if (!region) {
                // FIX: Use the defined 'extendedRegionCenters' instead of the undefined 'mergedCityToRegion'.
                region = extendedRegionCenters[originalKey];
            }
            break;
        }
    }

    // === 5. Паттерн "г. Подольск", "Люберцы г" если город еще не найден ===
    if (!city) {
        // Fix: Improved city pattern
        const cityMatch = clean.match(/\b(?:г|город|пгт|поселок|село|с|деревня|д)\s+([а-яё][а-яё-]*)/i);
        if (cityMatch?.[1]) {
            city = cityMatch[1].charAt(0).toUpperCase() + cityMatch[1].slice(1);
        }
    }

    // === 6. Fallback: центр региона ===
    const fallbackCity = region ? REGION_TO_CENTER[region] : null;
    if (!city && fallbackCity) {
        city = fallbackCity;
    }

    // === 7. Если регион МО, а город не найден — попробуем по частям адреса ===
    if (region === 'Московская область' && !city) {
        const parts = original.split(',');
        for (const part of parts) {
            const trimmed = part.trim();
            if (trimmed && !trimmed.match(/обл|область|мо/i) && trimmed.match(/[а-яё]/i)) {
                const candidate = trimmed.replace(/\s+(г|ул|д|мкр).*$/i, '').trim();
                if (candidate && candidate.length > 2) {
                    city = candidate.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    break;
                }
            }
        }
    }

    return {
        region: region || 'Регион не определён',
        city: city || 'Город не определён',
    };
}