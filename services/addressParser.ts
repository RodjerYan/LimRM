// services/addressParser.ts
import { regionCenters, normalizeRegion } from '../utils/addressMappings';
import { ParsedAddress } from '../types';

/* -------------------------------------------------------------
   1. Полный словарь fallback‑ключей
   ------------------------------------------------------------- */
const extendedRegionCenters: Record<string, string> = {
  ...regionCenters, // ваш базовый (центры регионов)

  // ── Калининградская область ─────────────────────────────────
  "гурьевск": "Калининградская область",
  "советск": "Калининградская область",
  "пионерский": "Калининградская область",
  "светлогорск": "Калининградская область",
  "светлый": "Калининградская область",
  "багратионовск": "Калининградская область",
  "большоеисаково": "Калининградская область",
  "голубево": "Калининградская область",
  "зеленоградск": "Калининградская область",
  "черняховск": "Калининградская область",
  "гвардейск": "Калининградская область",
  "балтийск": "Калининградская область",
  "матросово": "Калининградская область",
  "неман": "Калининградская область",
  "мамоново": "Калининградская область",


  // ── Санкт‑Петербург + Ленинградская область ─────────────────
  "спб": "Санкт-Петербург",
  "санктпетербург": "Санкт-Петербург",
  "санкт‑петербург": "Санкт-Петербург",
  "петербург": "Санкт-Петербург",
  "колпино": "Санкт-Петербург",
  "красное село": "Санкт-Петербург",
  "парголово": "Санкт-Петербург",
  "мурино": "Ленинградская область",
  "кудрово": "Ленинградская область",
  "пушкин": "Санкт-Петербург",
  "павловск": "Санкт-Петербург",
  "сланцы": "Ленинградская область",
  "ломоносов": "Ленинградская область",
  "сиверский": "Ленинградская область",
  "гатчина": "Ленинградская область",
  "всеволожск": "Ленинградская область",
  "волхов": "Ленинградская область",
  "кипень": "Ленинградская область",
  "ло": "Ленинградская область",
  "кириши": "Ленинградская область",
  "ивангород": "Ленинградская область",
  "кировск": "Ленинградская область",
  "лодейное-поле": "Ленинградская область",
  "луга": "Ленинградская область",
  "приозерск": "Ленинградская область",


  // ── Новгородская область ───────────────────────────────────
  "великийновгород": "Новгородская область",

  // ── Всё, что уже было в вашем файле (Крым, Краснодар, Кавказ…) ──
  // ───────────────────────────────────────────────────────────────
  // Республика Адыгея
  "теучеж": "Республика Адыгея",
  "энем": "Республика Адыгея",
  "трехстропье": "Республика Адыгея",
  "гиагинская": "Республика Адыгея",
  "коджеско": "Республика Адыгея",
  "тхабсим": "Республика Адыгея",
  "пшихач": "Республика Адыгея",
  "кужорская": "Республика Адыгея",

  // Республика Алтай
  "майма": "Республика Алтай",
  "чомыш": "Республика Алтай",
  "солонешное": "Республика Алтай",
  "кызыл-мазал": "Республика Алтай",
  "катуар": "Республика Алтай",
  "иогач": "Республика Алтай",
  "кокса": "Республика Алтай",
  "туекта": "Республика Алтай",

  // Республика Башкортостан
  "стерлитамак": "Республика Башкортостан",
  "салават": "Республика Башкортостан",
  "нефтекамск": "Республика Башкортостан",
  "белорецк": "Республика Башкортостан",
  "сибай": "Республика Башкортостан",
  "туймазы": "Республика Башкортостан",
  "кумертау": "Республика Башкортостан",
  "мега": "Республика Башкортостан",
  "октябрьский": "Республика Башкортостан",

  // Республика Бурятия
  "северобайкальск": "Республика Бурятия",
  "гусиноозерск": "Республика Бурятия",
  "severobaikalsk": "Республика Бурятия",
  "кижингу": "Республика Бурятия",
  "забайкальск": "Республика Бурятия",
  "борзя": "Республика Бурятия",
  "мухоршибирь": "Республика Бурятия",
  "таксимо": "Республика Бурятия",

  // Республика Дагестан
  "дербент": "Республика Дагестан",
  "каспийск": "Республика Дагестан",
  "хасавюрт": "Республика Дагестан",
  "южно-сулакский": "Республика Дагестан",
  "южно-сулак": "Республика Дагестан",
  "дагестанские огни": "Республика Дагестан",
  "избербаш": "Республика Дагестан",
  "хасавюртовский": "Республика Дагестан",
  "кизиляюрт": "Республика Дагестан",
  "цад аса": "Республика Дагестан", 
  "магомедали магомеджанова": "Республика Дагестан",
  "бамматюртовская": "Республика Дагестан",
  "омарова": "Республика Дагестан",
  "богратион": "Республика Дагестан",
  "бабаевский": "Республика Дагестан",
  "ш. каспийское": "Республика Дагестан",
  "казпийск": "Республика Дагестан", // Typo "Каспийск"
  "буйнакского": "Республика Дагестан",
  "каловская": "Республика Дагестан", // "Каспийская"
  "касп ийск": "Республика Дагестан", // Typo

  // Республика Ингушетия
  "назрань": "Республика Ингушетия",
  "малгобек": "Республика Ингушетия",
  "малгобекский": "Республика Ингушетия",
  "назрановский": "Республика Ингушетия",
  "сунженский": "Республика Ингушетия",
  "джейрахский": "Республика Ингушетия",
  "базоркина": "Республика Ингушетия",

  // Кабардино-Балкарская Республика
  "прохладный": "Кабардино-Балкарская Республика",
  "майский": "Кабардино-Балкарская Республика",
  "тырныауз": "Кабардино-Балкарская Республика",
  "баксан": "Кабардино-Балкарская Республика",
  "малка": "Кабардино-Балкарская Республика",
  "терск": "Кабардино-Балкарская Республика",
  "урванский": "Кабардино-Балкарская Республика",
  "захальдинский": "Кабардино-Балкарская Республика",
  "чегемский": "Кабардино-Балкарская Республика",
  "каху н": "Кабардино-Балкарская Республика", // "Кахун"
  "чегем": "Кабардино-Балкарская Республика",
  "нарткала": "Кабардино-Балкарская Республика",

  // Республика Калмыкия
  "городовиковск": "Республика Калмыкия",
  "ларино": "Республика Калмыкия",
  "яган": "Республика Калмыкия",
  "уста-хуру": "Республика Калмыкия",
  "ики-бурул": "Республика Калмыкия",
  "чернь": "Республика Калмыкия",
  "пантелеймон": "Республика Калмыкия",
  "приютное": "Республика Калмыкия",
  "ягорлык": "Республика Калмыкия",

  // Карачаево-Черкесская Республика
  "усть-джегута": "Карачаево-Черкесская Республика",
  "к Aram": "Карачаево-Черкесская Республика",
  "микоян": "Карачаево-Черкесская Республика",
  "зеленчукская": "Карачаево-Черкесская Республика",
  "хумара": "Карачаево-Черкесская Республика",
  "инж": "Карачаево-Черкесская Республика",
  "родники": "Карачаево-Черкесская Республика",
  "зеленчу кская": "Карачаево-Черкесская Республика", // "Зеленчукская"
  "ст. зеленчукская": "Карачаево-Черкесская Республика",


  // Республика Карелия
  "кемь": "Республика Карелия",
  "кондопога": "Республика Карелия",
  "сегежа": "Республика Карелия",
  "суоярви": "Республика Карелия",
  "сорск": "Республика Карелия",
  "питкяранта": "Республика Карелия",
  "олонец": "Республика Карелия",
  "лада": "Республика Карелия",
  "пудож": "Республика Карелия",

  // Республика Коми
  "инта": "Республика Коми",
  "воркута": "Республика Коми",
  "усинск": "Республика Коми",
  "пекра": "Республика Коми",
  "микунь": "Республика Коми",
  "сосногорск": "Республика Коми",
  "укта": "Республика Коми",
  "емва": "Республика Коми",
  "кослан": "Республика Коми",

  // Республика Крым
  "керчь": "Республика Крым",
  "ф еодосия": "Республика Крым",
  "феодосия": "Республика Крым",
  "ялта": "Республика Крым",
  "евпатория": "Республика Крым",
  "судак": "Республика Крым",
  "алушта": "Республика Крым",
  "бахчисарай": "Республика Крым",
  "симферопольский": "Республика Крым", 
  "саки": "Республика Крым", 
  "гвардейское": "Республика Крым", 
  "красногвардейское": "Республика Адыгея",
  "нижнегорский": "Республика Крым", 
  "кировское": "Республика Крым", 
  "ленино": "Республика Крым", 
  "раздольное": "Республика Крым", 
  "черноморское": "Республика Крым", 
  "джанкой": "Республика Крым", 
  "партенит": "Республика Крым", 
  "гурзуф": "Республика Крым", 
  "алупка": "Республика Крым", 
  "коктебель": "Республика Крым", 
  "вилина": "Республика Крым", 
  "зуя": "Республика Крым", 
  "кам енка": "Республика Крым", 
  "новофедоровка": "Республика Крым", 
  "уютное": "Республика Крым", 
  "заозёрное": "Республика Крым", 
  "белогорский": "Республика Крым", 
  "крымская роза": "Республика Крым",

  // Республика Марий Эл
  "волжск": "Республика Марий Эл",
  "зеленый город": "Республика Марий Эл",
  "медведево": "Республика Марий Эл",
  "морки": "Республика Марий Эл",
  "куженер": "Республика Марий Эл",
  "пайгарма": "Республика Марий Эл",
  "кизнер": "Республика Марий Эл",
  "советский": "Республика Марий Эл",
  "марий эл": "Республика Марий Эл",

  // Республика Мордовия
  "рузаевка": "Республика Мордовия",
  "ковылкино": "Республика Мордовия",
  "инсар": "Республика Мордовия",
  "арадат": "Республика Мордовия",
  "хамаска": "Республика Мордовия",
  "ромоданово": "Республика Мордовия",
  "чами": "Республика Мордовия",
  "мордовия": "Республика Мордовия",

  // Республика Саха (Якутия)
  "нерегу": "Республика Саха (Якутия)",
  "мирный": "Республика Саха (Якутия)",
  "покровск": "Республика Саха (Якутия)",
  "алданы": "Республика Саха (Якутия)",
  "нерюнгри": "Республика Саха (Якутия)",
  "хани": "Республика Саха (Якутия)",
  "дебины": "Республика Саха (Якутия)",
  "сунтар": "Республика Саха (Якутия)",
  "верхоянск": "Республика Саха (Якутия)",

  // Северная Осетия — Алания
  "моздок": "Республика Северная Осетия — Алания",
  "дигора": "Республика Северная Осетия — Алания",
  "ардон": "Республика Северная Осетия — Алания",
  "беса": "Республика Северная Осетия — Алания",
  "алджир": "Республика Северная Осетия — Алания",
  "гизель": "Республика Северная Осетия — Алания",
  "пригородный": "Республика Северная Осетия — Алания",
  "кимо": "Республика Северная Осетия — Алания",
  "ног ир": "Республика Северная Осетия — Алания", // "Ногир"
  "северная осетия": "Республика Северная Осетия — Алания",
  "армянская": "Республика Северная Осетия — Алания",


  // Республика Татарстан
  "назеля": "Республика Татарстан",
  "альметьевск": "Республика Татарстан",
  "набережные-челны": "Республика Татарстан",
  "нижнекамск": "Республика Татарстан",
  "еленовка": "Республика Татарстан",
  "заинск": "Республика Татарстан",
  "чистополь": "Республика Татарстан",
  "нурлат": "Республика Татарстан",
  "арск": "Республика Татарстан",

  // Республика Тыва
  "ак-довурок": "Республика Тыва",
  "тоожу": "Республика Тыва",
  "сарыг-сеп": "Республика Тыва",
  "кай": "Республика Тыва",
  "тээли": "Республика Тыва",
  "чадаан": "Республика Тыва",
  "чурга": "Республика Тыва",
  "самагалтай": "Республика Тыва",
  "тоя": "Республика Тыва",

  // Удмуртская Республика
  "сарапул": "Удмуртская Республика",
  "мокси": "Удмуртская Республика",
  "гольяны": "Удмуртская Республика",
  "кез": "Удмуртская Республика",
  "григорьевка": "Удмуртская Республика",
  "ишим": "Удмуртская Республика",
  "дебёсы": "Удмуртская Республика",
  "каракулино": "Удмуртская Республика",
  "кильмезь": "Удмуртская Республика",

  // Республика Хакасия
  "черногорск": "Республика Хакасия",
  "саяногорск": "Республика Хакасия",
  "абаза": "Республика Хакасия",
  "таштагол": "Республика Хакасия",
  "уст-абакан": "Республика Хакасия",
  "бея": "Республика Хакасия",
  "альберт": "Республика Хакасия",

  // Чеченская Республика
  "гудаур": "Чеченская Республика",
  "ургуб": "Чеченская Республика",
  "шали": "Чеченская Республика",
  "ургус-стан": "Чеченская Республика",
  "аргун": "Чеченская Республика",
  "гудермес": "Чеченская Республика",
  "кезенойам": "Чеченская Республика",
  "центорой": "Чеченская Республика",
  "самашки": "Чеченская Республика",
  "бисултанова": "Чеченская Республика",
  "мухаммада али": "Чеченская Республика",
  "германа угрюмова": "Чеченская Республика",


  // Чувашская Республика
  "новочебоксарск": "Чувашская Республика",
  "цивиля": "Чувашская Республика",
  "алатырь": "Чувашская Республика",
  "юман": "Чувашская Республика",
  "канадей": "Чувашская Республика",
  "клетия": "Чувашская Республика",
  "цивильск": "Чувашская Республика",

  // ──────────────────────────────────────────────────────────────
  // **КРАЯ** (9 шт.)
  // ──────────────────────────────────────────────────────────────
  // Алтайский край
  "бийск": "Алтайский край",
  "рубцовск": "Алтайский край",
  "новоалтайск": "Алтайский край",
  "змеиногорск": "Алтайский край",
  "алтайское": "Алтайский край",
  "благовещенка": "Алтайский край",
  "александровка": "Алтайский край",
  "косиха": "Алтайский край",

  // Забайкальский край
  "чите": "Забайкальский край",
  "краснокаменск": "Забайкальский край",
  "балей": "Забайкальский край",
  "петровск- Забайкальский": "Забайкальский край",
  "могоча": "Забайкальский край",
  "чернышевск": "Забайкальский край",
  "карымское": "Забайкальский край",
  "кыра": "Забайкальский край",

  // Камчатский край
  "вилючинск": "Камчатский край",
  "елизово": "Камчатский край",
  "паратунка": "Камчатский край",
  "мильково": "Камчатский край",
  "палана": "Камчатский край",
  "усть-камчатск": "Камчатский край",
  "тигиль": "Камчатский край",
  "коряки": "Камчатский край",
  "быстринский": "Камчатский край",

  // Краснодарский край
  "армавир": "Краснодарский край",
  "новороссийск": "Краснодарский край",
  "туапсе": "Краснодарский край",
  "славянск-на-кубани": "Краснодарский край",
  "гостагаевская": "Краснодарский край", 
  "тихо рецк": "Краснодарский край", 
  "тихорецк": "Краснодарский край", 
  "динская": "Краснодарский край", 
  "адлерский": "Краснодарский край", 
  "полтавская": "Краснодарский край", 
  "владимирская": "Краснодарский край", 
  "красноадр": "Краснодарский край", 
  "северская": "Краснодарский край", 
  "темрюк": "Краснодарский край", 
  "elizavetinskaya": "Краснодарский край", 
  "лабинск": "Краснодарский край", 
  "тим ашевск": "Краснодарский край", 
  "тимашевск": "Краснодарский край", 
  "п. плодородный": "Краснодарский край", 
  "гулькевичевский": "Краснодарский край", 
  "новоукраинское": "Краснодарский край", 
  "знаменский": "Краснодарский край", 
  "выселки": "Краснодарский край", 
  "старовиличковская": "Краснодарский край", 
  "островского": "Краснодарский край", 
  "мостовской": "Краснодарский край", 
  "новотитаровская": "Краснодарский край", 
  "морозова": "Краснодарский край", 
  "анапская": "Краснодарский край", 
  "варенниковская": "Краснодарский край", 
  "парус": "Краснодарский край", 
  "молдавка": "Краснодарский край", 
  "калининская": "Краснодарский край", 
  "виноградный": "Краснодарский край", 
  "лен инградская": "Краснодарский край", 
  "усть-лабинск": "Краснодарский край", 
  "васюринская": "Краснодарский край", 
  "фадеева": "Краснодарский край", 
  "солдатских матерей": "Краснодарский край", 
  "горячий ключ": "Краснодарский край", 
  "новонабережная": "Краснодарский край", 
  "ильский": "Краснодарский край", 
  "коммунистическая": "Краснодарский край", 
  "парковая": "Краснодарский край", 
  "железнодорожная": "Краснодарский край", 
  "воровского": "Краснодарский край", 
  "пустошкина": "Краснодарский край", 
  "крымск": "Краснодарский край", 
  "тамань": "Краснодарский край", 
  "гоголя": "Краснодарский край", 
  "курганинский": "Краснодарский край", 
  "михайловская": "Краснодарский край", 
  "индустриальная": "Краснодарский край", 
  "карла маркса": "Краснодарский край", 
  "50 лет октября": "Краснодарский край", 
  "ейск": "Краснодарский край", 
  "раевская": "Краснодарский край", 
  "апшеронск": "Краснодарский край", 
  "ленинградская": "Краснодарский край", 
  "крутой": "Краснодарский край", 
  "победы": "Краснодарский край", 
  "славянск на кубани": "Краснодарский край", 
  "тбилисская": "Краснодарский край", 
  "гулькевичи": "Краснодарский край", 
  "ярославского": "Краснодарский край", 
  "ростовское шоссе": "Краснодарский край", 
  "старотитаровская": "Краснодарский край", 
  "цибанобалка": "Краснодарский край", 
  "депутатская": "Краснодарский край", 
  "космическая": "Краснодарский край", 
  "адмирала пустошкина": "Краснодарский край", 
  "курчанская": "Краснодарский край", 
  "свердлова": "Краснодарский край", 
  "авиационная": "Краснодарский край", 
  "трудобеликовский": "Краснодарский край", 
  "широкая щель": "Краснодарский край", 
  "анастасиевская": "Краснодарский край", 
  "ковтюха": "Краснодарский край", 
  "рыночная площадь": "Краснодарский край", 
  "запорожская": "Краснодарский край", 
  "батерейная": "Краснодарский край", 
  "50 лет вклксм": "Краснодарский край", 
  "новомышастовская": "Краснодарский край", 
  "совхозный": "Краснодарский край", 
  "сенной": "Краснодарский край", 
  "базарная": "Краснодарский край", 
  "старокорсунская": "Краснодарский край", 
  "медведовская": "Краснодарский край", 
  "торговая": "Краснодарский край",

  // Красноярский край
  "норильск": "Красноярский край",
  "ачинск": "Красноярский край",
  "кандалакша": "Красноярский край",
  "лесосибирск": "Красноярский край",
  "минусино": "Красноярский край",
  "сосновоборск": "Красноярский край",
  "забаикальск": "Красноярский край",

  // Пермский край
  "березники": "Пермский край",
  "соликамск": "Пермский край",
  "чайковский": "Республика Мордовия",
  "лысьва": "Пермский край",
  "кизел": "Пермский край",
  "чусовой": "Пермский край",
  "кос": "Пермский край",
  "добрянка": "Пермский край",
  "губаха": "Пермский край",

  // Приморский край
  "у ss ур ийск": "Приморский край",
  "нах одка": "Приморский край",
  "артем": "Приморский край",
  "лау тов": "Приморский край",
  "спасск-дальний": "Приморский край",
  "дальнереченск": "Приморский край",
  "покровское": "Приморский край",
  "лучегорск": "Приморский край",
  "фокино": "Брянская область",

  // Ставропольский край
  "пятигорск": "Ставропольский край",
  "минеральные-воды": "Ставропольский край",
  "кисловодск": "Ставропольский край",
  "невинномысск": "Ставропольский край",
  "буденновск": "Ставропольский край",
  "ессентуки": "Ставропольский край",
  "г еоргиевск": "Ставропольский край",
  "изобильный": "Ставропольский край",
  "светлоград": "Ставропольский край",
  "новоалександровск": "Ставропольский край", 
  "михайловск": "Ставропольский край", 
  "лермонтов": "Ставропольский край", 
  "нефтекумск": "Ставропольский край", 
  "благодарный": "Ставропольский край", 
  "кочубеевское": "Ставропольский край", 
  "донское": "Ставропольский край", 
  "архангельское": "Ставропольский край", 
  "иноземцево": "Ставропольский край", 
  "преображенское": "Ставропольский край", 
  "солдато-александровское": "Ставропольский край", 
  "праковея": "Ставропольский край", 
  "новоселицкое": "Ставропольский край", 
  "рыздвяный": "Ставропольский край", 
  "левокумское": "Ставропольский край", 
  "новотроицкая": "Ставропольский край", 
  "винсады": "Ставропольский край", 
  "зеленокумск": "Ставропольский край", 
  "железноводск": "Ставропольский край", 
  "демино": "Ставропольский край", 
  "мел иоратор": "Ставропольский край", 
  "ж илноводск": "Ставропольский край", 
  "кочубея": "Ставропольский край", 
  "барсуковская": "Ставропольский край", 
  "пролетарское": "Ставропольский край",
  "санько": "Ставропольский край",
  "колесникова": "Ставропольский край", // Person, but fallback
  "д нт": "Ставропольский край", // "ДНТ"
  "минральные воды": "Ставропольский край", // Typo
  "г ессентуки": "Ставропольский край", // Typo
  "г. ессентуки": "Ставропольский край",
  "нив инномыск": "Ставропольский край", // "Невинномысск"

  // Хабаровский край
  "комсомольск-на-амуре": "Хабаровский край",
  "юности": "Хабаровский край",
  "хабаровский": "Хабаровский край",
  "амурск": "Хабаровский край",
  "николаевск-на-амуре": "Хабаровский край",
  "ванино": "Хабаровский край",
  "советская-Гавань": "Хабаровский край",
  "хурмули": "Хабаровский край",

  // ──────────────────────────────────────────────────────────────
  // **ОБЛАСТИ** (48 шт.)
  // ──────────────────────────────────────────────────────────────
  // Амурская область
  "свободный": "Амурская область",
  "белогорск": "Республика Крым",
  "райчихинск": "Амурская область",
  "прогресс": "Амурская область",
  "зея": "Амурская область",
  "тында": "Амурская область",
  "уркана": "Амурская область",
  "серышево": "Амурская область",
  "сковородино": "Амурская область",

  // Архангельская область
  "северодвинск": "Архангельская область",
  "котлас": "Архангельская область",
  "коряжма": "Архангельская область",
  "новодвинск": "Архангельская область",
  "карпогоры": "Архангельская область",
  "моржовец": "Архангельская область",
  "пинег": "Архангельская область",
  "мезень": "Архангельская область",

  // Астраханская область
  "знаменск": "Астраханская область",
  "ахтубинск": "Астраханская область",
  "харабалин": "Астраханская область",
  "нариманов": "Астраханская область",
  "ипатово": "Ставропольский край",
  "володарский": "Астраханская область",
  "карамышка": "Астраханская область",
  "чернышков": "Астраханская область",
  "хаджи-мurat": "Астраханская область",

  // Белгородская область
  "старый-ос кол": "Белгородская область",
  "губкин": "Белгородская область",
  "шевенг": "Белгородская область",
  "старово": "Белгородская область",
  "алексеевка": "Самарская область",
  "валуйки": "Белгородская область",
  "степан": "Белгородская область",
  "разумное": "Белгородская область",
  "томаровка": "Белгородская область",

  // Брянская область
  "клинцы": "Брянская область",
  "новозыбков": "Брянская область",
  "унеча": "Брянская область",
  "кардым": "Брянская область",
  "сельцо": "Брянская область",
  "дыбово": "Брянская область",
  "мглин": "Брянская область",

  // Владимирская область
  "ковров": "Владимирская область",
  "музров": "Владимирская область",
  "александров": "Владимирская область",
  "колу тов": "Владимирская область",
  "суздаль": "Владимирская область",
  "гусь-хрустальный": "Владимирская область",
  "покров": "Владимирская область",
  "собинка": "Владимирская область",
  "вязники": "Владимирская область",

  // Волгоградская область
  "михайловка": "Волгоградская область",
  "урюпино": "Волгоградская область",
  "фролово": "Волгоградская область",
  "светлый-яр": "Волгоградская область",
  "котов": "Волгоградская область",
  "николаевск": "Волгоградская область",
  "иловля": "Волгоградская область",

  // Вологодская область
  "череповец": "Вологодская область",
  "сокол": "Вологодская область",
  "тотьма": "Вологодская область",
  "великий-устюг": "Вологодская область",
  "кадый": "Вологодская область",
  "грахово": "Вологодская область",
  "харовск": "Вологодская область",
  "вытегра": "Вологодская область",

  // Воронежская область
  "борисоглебск": "Воронежская область",
  "ус ман": "Воронежская область",
};
// FIX: Add the missing `parseRussianAddress` function and necessary helpers.
// This block of code implements a robust, multi-strategy address parser
// that resolves the "exported member not found" compilation error.

// --- Pre-computed values for performance within the worker ---
const allRegions = [...new Set(Object.values(regionCenters).concat(Object.values(extendedRegionCenters)))]
    .map(r => ({ normalized: r.toLowerCase(), original: normalizeRegion(r) }))
    // Sort to match longest region name first (e.g., "Кабардино-Балкарская Республика" before "Республика")
    .sort((a, b) => b.normalized.length - a.normalized.length);

const sortedExtendedKeys = Object.keys(extendedRegionCenters).sort((a, b) => b.length - a.length);
const sortedBaseKeys = Object.keys(regionCenters).sort((a, b) => b.length - a.length);

const regionToCenterMap: Record<string, string> = {};
for (const [city, region] of Object.entries(regionCenters)) {
    regionToCenterMap[region] = city.charAt(0).toUpperCase() + city.slice(1);
}

/**
 * Parses a raw Russian address string to extract the region and city.
 * It uses a combination of dictionary lookups and pattern matching for robustness.
 * This function is designed to be fast and run inside a Web Worker.
 * @param address The raw address string.
 * @returns A `ParsedAddress` object containing the identified region and city.
 */
export function parseRussianAddress(address: string): ParsedAddress {
    if (!address) {
        return { region: 'Регион не определён', city: 'Город не определён' };
    }

    const lowerCaseAddress = address.toLowerCase();
    // A more aggressive cleaning for dictionary lookups
    const cleanedAddress = lowerCaseAddress.replace(/[^а-я0-9\s-]/g, ' ').replace(/\s+/g, ' ').trim();
    
    let foundRegion: string | null = null;
    let foundCity: string | null = null;
    let cityFromDict: string | null = null;

    // Strategy 1: Find an explicit region name in the address. This is often the most reliable signal.
    for (const region of allRegions) {
        if (lowerCaseAddress.includes(region.normalized)) {
            foundRegion = region.original;
            break;
        }
    }
    
    // Strategy 2: Find city from dictionaries. If a region hasn't been found yet,
    // this will provide a good fallback.
    // Prioritize extended dictionary.
    for (const key of sortedExtendedKeys) {
        if (cleanedAddress.includes(key)) {
            cityFromDict = key;
            if (!foundRegion) {
                foundRegion = extendedRegionCenters[key];
            }
            break;
        }
    }
    // Fallback to base dictionary if nothing found yet.
    if (!cityFromDict) {
        for (const key of sortedBaseKeys) {
            if (cleanedAddress.includes(key)) {
                cityFromDict = key;
                if (!foundRegion) {
                    foundRegion = regionCenters[key];
                }
                break;
            }
        }
    }
    
    // Strategy 3: Heuristics to find the city name.
    if (cityFromDict) {
        foundCity = cityFromDict.charAt(0).toUpperCase() + cityFromDict.slice(1);
    } else {
        // Look for "г. CityName" pattern if no city was found in dictionaries.
        const cityMatch = lowerCaseAddress.match(/(?:г\.|город)\s*([а-яё-]+)/i);
        if (cityMatch && cityMatch[1]) {
            foundCity = cityMatch[1].charAt(0).toUpperCase() + cityMatch[1].slice(1);
        }
    }

    // Strategy 4: Fallback city to regional center if city is unknown but region is known.
    const fallbackCity = foundRegion ? regionToCenterMap[foundRegion] : null;

    return {
        region: foundRegion || 'Регион не определён',
        city: foundCity || fallbackCity || 'Город не определён',
    };
}
